name: Release Build

on:
  push:
    branches: [main]

jobs:
  build-and-release:
    name: ë¹Œë“œ ë° GitHub Release ìƒì„±
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“¦ pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v4

      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: ğŸ”¨ ë¹Œë“œ ì‹¤í–‰
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
        run: pnpm run build

      - name: ğŸ“ ë¹Œë“œ íŒŒì¼ í™•ì¸
        run: |
          echo "ë¹Œë“œëœ íŒŒì¼ ëª©ë¡:"
          find . -name "*.ait" -type f
          
      - name: ğŸ“¦ ë²„ì „ ì •ë³´ ì¶”ì¶œ
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ í˜„ì¬ ë²„ì „: v${VERSION}"

      - name: ğŸ“¦ .ait íŒŒì¼ ì°¾ê¸°
        id: find_file
        run: |
          AIT_FILE=$(find . -name "*.ait" -type f | head -n 1)
          if [ -z "$AIT_FILE" ]; then
            echo "âŒ .ait íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo "file_path=${AIT_FILE}" >> $GITHUB_OUTPUT
          echo "file_name=onsurvey_v${{ steps.version.outputs.version }}.ait" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ë°œê²¬ëœ íŒŒì¼: ${AIT_FILE}"

      - name: ğŸ·ï¸ íŒŒì¼ëª… ë³€ê²½
        run: |
          cp "${{ steps.find_file.outputs.file_path }}" "${{ steps.find_file.outputs.file_name }}"
          ls -lh "${{ steps.find_file.outputs.file_name }}"

      - name: ğŸ“± ì•± ë²ˆë“¤ ìë™ ë°°í¬
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          AIT_API_KEY: ${{ secrets.AIT_API_KEY }}
        run: |
          if [ -z "$AIT_API_KEY" ]; then
            echo "âš ï¸  AIT_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi
          echo "ğŸš€ ì•± ë²ˆë“¤ì„ ë°°í¬í•©ë‹ˆë‹¤..."
          npx ait deploy --api-key "$AIT_API_KEY"
          echo "âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"

      - name: ğŸš€ GitHub Release ìƒì„± ë° íŒŒì¼ ì—…ë¡œë“œ
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: |
            ## ğŸ“¦ OnSurvey v${{ steps.version.outputs.version }}
            
            ### ë‹¤ìš´ë¡œë“œ
            ì•„ë˜ Assetsì—ì„œ `${{ steps.find_file.outputs.file_name }}`ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.
            
            ### ë¹Œë“œ ì •ë³´
            - **ë²„ì „**: v${{ steps.version.outputs.version }}
            - **ë¹Œë“œ ë‚ ì§œ**: ${{ github.event.head_commit.timestamp }}
            - **ì»¤ë°‹**: ${{ github.sha }}
            
            ---
            _ìë™ìœ¼ë¡œ ìƒì„±ëœ ë¦´ë¦¬ì¦ˆì…ë‹ˆë‹¤._
          files: |
            ${{ steps.find_file.outputs.file_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… ë¦´ë¦¬ì¦ˆ ì™„ë£Œ (Main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ‰ GitHub Releaseê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo ""
          echo "ğŸ“Œ ë²„ì „: ${{ steps.version.outputs.tag }}"
          echo "ğŸ“¦ íŒŒì¼ëª…: ${{ steps.find_file.outputs.file_name }}"
          echo "ğŸ”— ë¦´ë¦¬ì¦ˆ í˜ì´ì§€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
          echo "â¬‡ï¸  ì§ì ‘ ë‹¤ìš´ë¡œë“œ: https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/${{ steps.find_file.outputs.file_name }}"

      - name: âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ (PR)
        if: github.event_name == 'pull_request'
        run: |
          echo "âœ¨ ë¹Œë“œ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“Œ ë²„ì „: ${{ steps.version.outputs.tag }}"
          echo "ğŸ“¦ íŒŒì¼ëª…: ${{ steps.find_file.outputs.file_name }}"
          echo ""
          echo "â„¹ï¸  PRì´ë¯€ë¡œ ReleaseëŠ” ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "â„¹ï¸  main ë¸Œëœì¹˜ì— ë¨¸ì§€ë˜ë©´ ìë™ìœ¼ë¡œ Releaseê°€ ìƒì„±ë©ë‹ˆë‹¤."

