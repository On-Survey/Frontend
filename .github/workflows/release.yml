name: Release Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-upload:
    name: ë¹Œë“œ ë° êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—…ë¡œë“œ
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ“¦ pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v4

      - name: ðŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ðŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: ðŸ”¨ ë¹Œë“œ ì‹¤í–‰
        run: pnpm run build

      - name: ðŸ“ ë¹Œë“œ íŒŒì¼ í™•ì¸
        run: |
          echo "ë¹Œë“œëœ íŒŒì¼ ëª©ë¡:"
          ls -lh dist/ || ls -lh build/ || echo "ë¹Œë“œ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

      - name: ðŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Google API í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: ðŸ“¤ êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì—…ë¡œë“œ
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          cat > upload_to_drive.py << 'EOF'
          import os
          import json
          from datetime import datetime
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          import glob

          # ì„œë¹„ìŠ¤ ê³„ì • ì¸ì¦
          credentials_json = os.environ['GOOGLE_CREDENTIALS']
          credentials_dict = json.loads(credentials_json)
          credentials = service_account.Credentials.from_service_account_info(
              credentials_dict,
              scopes=['https://www.googleapis.com/auth/drive.file']
          )

          # Drive API í´ë¼ì´ì–¸íŠ¸ ìƒì„±
          service = build('drive', 'v3', credentials=credentials)

          # ë£¨íŠ¸ í´ë” ID
          root_folder_id = os.environ['GOOGLE_DRIVE_FOLDER_ID']

          # package.jsonì—ì„œ ë²„ì „ ì½ê¸°
          with open('package.json', 'r') as f:
              package_data = json.load(f)
              version = package_data.get('version', '0.0.0')
          
          print(f"ðŸ“Œ í˜„ìž¬ ë²„ì „: v{version}")

          # .ait íŒŒì¼ ì°¾ê¸°
          ait_files = glob.glob('**/*.ait', recursive=True)
          
          if not ait_files:
              print("âŒ .ait íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
              exit(1)

          ait_file = ait_files[0]
          print(f"ðŸ“¦ ì—…ë¡œë“œí•  íŒŒì¼: {ait_file}")

          # ë‚ ì§œë³„ í´ë”ëª… ìƒì„±
          now = datetime.now()
          date_folder_name = now.strftime('%Y-%m-%d')
          date_str = now.strftime('%Y-%m-%d %H:%M:%S')
          time_str = now.strftime('%H%M%S')
          
          print(f"ðŸ“ í´ë” ìƒì„±/í™•ì¸: {date_folder_name}")

          # ë‚ ì§œ í´ë” ì°¾ê¸° ë˜ëŠ” ìƒì„±
          query = f"name='{date_folder_name}' and '{root_folder_id}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false"
          results = service.files().list(q=query, fields='files(id, name)').execute()
          folders = results.get('files', [])

          if folders:
              date_folder_id = folders[0]['id']
              print(f"âœ“ ê¸°ì¡´ í´ë” ì‚¬ìš©: {date_folder_name}")
          else:
              folder_metadata = {
                  'name': date_folder_name,
                  'mimeType': 'application/vnd.google-apps.folder',
                  'parents': [root_folder_id]
              }
              folder = service.files().create(body=folder_metadata, fields='id').execute()
              date_folder_id = folder['id']
              print(f"âœ“ ìƒˆ í´ë” ìƒì„±: {date_folder_name}")

          # íŒŒì¼ëª… ìƒì„± (ë²„ì „ í¬í•¨)
          file_name = f"onsurvey_v{version}_{time_str}.ait"

          # íŒŒì¼ ë©”íƒ€ë°ì´í„°
          file_metadata = {
              'name': file_name,
              'parents': [date_folder_id],
              'description': f'Version: v{version}\nBuild Date: {date_str}\nBuild from GitHub Actions'
          }

          # íŒŒì¼ ì—…ë¡œë“œ
          print(f"â¬†ï¸  ì—…ë¡œë“œ ì¤‘...")
          media = MediaFileUpload(ait_file, resumable=True)
          file = service.files().create(
              body=file_metadata,
              media_body=media,
              fields='id, name, webViewLink, webContentLink'
          ).execute()

          print(f"\nâœ… ì—…ë¡œë“œ ì™„ë£Œ!")
          print(f"ðŸ“ í´ë”: {date_folder_name}")
          print(f"ðŸ“¦ íŒŒì¼ëª…: {file.get('name')}")
          print(f"ðŸ”— ë³´ê¸° ë§í¬: {file.get('webViewLink')}")
          print(f"â¬‡ï¸  ë‹¤ìš´ë¡œë“œ ë§í¬: {file.get('webContentLink')}")
          print(f"ðŸ“Œ íŒŒì¼ ID: {file.get('id')}")

          # GitHub Actions ì¶œë ¥ìœ¼ë¡œ ì €ìž¥
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"version=v{version}\n")
              f.write(f"folder_name={date_folder_name}\n")
              f.write(f"file_id={file.get('id')}\n")
              f.write(f"file_name={file.get('name')}\n")
              f.write(f"file_link={file.get('webViewLink')}\n")
              f.write(f"download_link={file.get('webContentLink', 'N/A')}\n")
          EOF

          python upload_to_drive.py
        id: upload

      - name: âœ… ì—…ë¡œë“œ ì™„ë£Œ
        run: |
          echo "ðŸŽ‰ ë¹Œë“œ íŒŒì¼ì´ êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo ""
          echo "ðŸ“Œ ë²„ì „: ${{ steps.upload.outputs.version }}"
          echo "ðŸ“ í´ë”: ${{ steps.upload.outputs.folder_name }}"
          echo "ðŸ“¦ íŒŒì¼ëª…: ${{ steps.upload.outputs.file_name }}"
          echo "ðŸ”— ë³´ê¸° ë§í¬: ${{ steps.upload.outputs.file_link }}"
          echo "â¬‡ï¸  ë‹¤ìš´ë¡œë“œ: ${{ steps.upload.outputs.download_link }}"

